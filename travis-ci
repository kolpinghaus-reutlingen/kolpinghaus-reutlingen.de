set -e

DEPLOY_REPO="https://${REPO_KEY}@github.com/kolpinghaus-rt/kolpinghaus-reutlingen.de.git"

function main {
	clean_before
	get_current_site
	safe
	clean_after
	build_site
	restore
	htmlproofer
	deploy
}

function clean_before {
	echo "cleaning _site folder"
	if [ -d "_site" ]; then rm -Rf _site; fi
	mkdir _site
}

function get_current_site {
	echo "getting latest site"
	git clone --depth 1 $DEPLOY_REPO _site
}

function safe {
	echo 'safe'
	if [ -d "../temp" ]; then rm -Rf ../temp; fi
	mkdir ../temp
	mv _site/README.md _site/.gitignore _site/.git ../temp/
}


function clean_after {
	echo "cleaning _site folder again"
	rm -Rf _site/
}

function build_site {
	echo "building site"
	JEKYLL_ENV=production bundle exec jekyll build --trace
}


function restore {
	echo 'restore'

	mv ../temp/README.md ../temp/.gitignore ../temp/.git _site/
}

function htmlproofer {
	bundle exec htmlproofer ./_site --disable-external
}

function deploy {
	echo "deploying changes"

	if [ -z "$TRAVIS_PULL_REQUEST" ]; then
	    echo "except don't publish site for pull requests"
	    exit 0
	fi

	if [ "$TRAVIS_BRANCH" != "master" ]; then
	    echo "except we should only publish the master branch. stopping here"
	    exit 0
	fi

	cd _site
	git config --global user.name "Travis CI"
    git config --global user.email travis-ci@kolpinghaus-reutlingen.de
	git add -A
	git status
	git commit -m ""travisbuild $TRAVIS_BUILD_NUMBER" -m "${TRAVIS_COMMIT_MESSAGE}"
	git push $DEPLOY_REPO master:master
}

main
